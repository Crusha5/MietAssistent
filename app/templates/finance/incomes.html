{% extends "base.html" %}
{% block title %}Finanzen - Einnahmen erfassen{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Finanzen · Einnahmen</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.dashboard') }}"><i class="bi bi-arrow-left"></i> Zurück zum Dashboard</a>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Einnahme erfassen</h6>
        <small class="text-muted">Mieter & Vertrag wählen, Betrag und Verwendungszweck eintragen</small>
    </div>
    <div class="card-body">
        <form class="row g-3" method="post" action="{{ url_for('finances.create_income') }}" id="financeIncomeForm">
            <div class="col-md-4">
                <label class="form-label">Mieter</label>
                <select class="form-select" name="tenant_id" id="finance_tenant">
                    <option value="">Bitte wählen</option>
                    {% for tenant in tenants %}
                    <option value="{{ tenant.id }}">{{ tenant.first_name }} {{ tenant.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Vertrag</label>
                <select class="form-select" name="contract_id" id="finance_contract" required>
                    <option value="">Bitte wählen</option>
                    {% for contract in contracts %}
                    <option value="{{ contract.id }}" data-tenant="{{ contract.tenant_id }}">{{ contract.contract_number }} – {{ contract.apartment.get_full_identifier() if contract.apartment else '' }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Kategorie</label>
                <select class="form-select" name="income_category" id="finance_category" required>
                    <option value="rent">Kaltmiete</option>
                    <option value="service">Nebenkosten</option>
                    <option value="special">Sonderzahlung</option>
                    <option value="deposit">Kaution</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Betrag (Gesamt)</label>
                <input type="number" step="0.01" name="amount" class="form-control" id="finance_total" placeholder="0,00" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Datum</label>
                <input type="date" name="received_on" class="form-control" value="{{ now().strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Verwendungszweck</label>
                <input type="text" name="reference" class="form-control" placeholder="z. B. NK Januar">
            </div>
            <div class="col-md-12">
                <label class="form-label">Notiz (optional)</label>
                <textarea name="notes" rows="2" class="form-control" placeholder="Interne Notizen"></textarea>
            </div>
            <div class="col-md-4">
                <label class="form-label">Quelle (optional)</label>
                <input type="text" name="source" class="form-control" placeholder="Konto, Kasse …">
            </div>
            <div class="col-md-4 form-check mt-4">
                <input class="form-check-input" type="checkbox" value="1" id="finance_advance" name="is_advance_payment">
                <label class="form-check-label" for="finance_advance">Vorauszahlung</label>
            </div>
            <div class="col-12">
                <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> Speichern</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <form class="row g-2 mb-3" method="get">
            <div class="col-md-3">
                <select class="form-select" name="tenant_id">
                    <option value="">Alle Mieter</option>
                    {% for tenant in tenants %}
                    <option value="{{ tenant.id }}" {% if filters.tenant_id == tenant.id %}selected{% endif %}>{{ tenant.first_name }} {{ tenant.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="contract_id">
                    <option value="">Alle Verträge</option>
                    {% for contract in contracts %}
                    <option value="{{ contract.id }}" {% if filters.contract_id == contract.id %}selected{% endif %}>{{ contract.contract_number }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="q" value="{{ filters.q }}" placeholder="Verwendungszweck oder Notiz">
            </div>
            <div class="col-md-3 d-grid d-md-flex gap-2">
                <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Filtern</button>
                <a class="btn btn-outline-secondary" href="{{ url_for('finances.incomes_overview') }}">Zurücksetzen</a>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Mieter</th>
                        <th>Vertrag</th>
                        <th>Kategorie</th>
                        <th>Gesamt</th>
                        <th>Vorauszahlung</th>
                        <th>Verwendungszweck</th>
                        <th class="text-end">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for income in incomes %}
                    <tr>
                        <td>{{ income.received_on.strftime('%d.%m.%Y') if income.received_on else '—' }}</td>
                        <td>{{ income.tenant.first_name + ' ' + income.tenant.last_name if income.tenant else '—' }}</td>
                        <td><span class="badge bg-light text-dark">{{ income.contract.contract_number if income.contract else '—' }}</span></td>
                        <td>
                            {% if income.income_type == 'service_charge' %}Nebenkosten{% elif income.income_type == 'extra' %}Sonderzahlung{% elif income.income_type == 'deposit' %}Kaution{% else %}Kaltmiete{% endif %}
                        </td>
                        <td class="fw-semibold">{{ '%.2f'|format(income.amount or 0) }} €</td>
                        <td>{% if income.is_advance_payment %}<span class="badge bg-info">Ja</span>{% else %}—{% endif %}</td>
                        <td>{{ income.reference or '—' }}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#incomeModal"
                                data-id="{{ income.id }}"
                                data-amount="{{ income.amount }}"
                                data-rent="{{ income.rent_portion or 0 }}"
                                data-service="{{ income.service_charge_portion or 0 }}"
                                data-special="{{ income.special_portion or 0 }}"
                                data-type="{{ income.income_type }}"
                                data-date="{{ income.received_on.strftime('%Y-%m-%d') if income.received_on else '' }}"
                                data-notes="{{ income.notes or '' }}"
                                data-contract="{{ income.contract_id }}"
                                data-tenant="{{ income.tenant_id or '' }}"
                                data-reference="{{ income.reference or '' }}"
                                data-advance="{{ '1' if income.is_advance_payment else '' }}"
                                data-source="{{ income.source or '' }}"
                                data-update-url="{{ url_for('finances.update_income', income_id=income.id) }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="post" action="{{ url_for('finances.delete_income_entry', income_id=income.id) }}" class="d-inline">
                                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Eintrag löschen?')"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="8" class="text-center text-muted py-3">Keine Zahlungen erfasst.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <nav class="mt-3">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('finances.incomes_overview', page=pagination.prev_num, **filters) }}">Zurück</a>
                </li>
                <li class="page-item disabled"><span class="page-link">Seite {{ pagination.page }} / {{ pagination.pages or 1 }}</span></li>
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('finances.incomes_overview', page=pagination.next_num, **filters) }}">Weiter</a>
                </li>
            </ul>
        </nav>
    </div>
</div>
{% include 'main/income_due_modals.html' %}
{% endblock %}
{% block extra_js %}
{{ super() }}
{% include 'main/income_due_js.html' %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const contractSelect = document.getElementById('finance_contract');
        const tenantSelect = document.getElementById('finance_tenant');
        if (contractSelect && tenantSelect) {
            contractSelect.addEventListener('change', () => {
                const opt = contractSelect.selectedOptions[0];
                if (opt && opt.dataset.tenant) {
                    tenantSelect.value = opt.dataset.tenant;
                }
            });
            tenantSelect.addEventListener('change', () => {
                const val = tenantSelect.value;
                if (!val) return;
                const match = Array.from(contractSelect.options).find(o => o.dataset.tenant === val);
                if (match) contractSelect.value = match.value;
            });
        }
    });
</script>
{% endblock %}
