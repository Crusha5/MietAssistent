{% extends "base.html" %}
{% block title %}Instandhaltungs- und Wartungsplaner{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h4 mb-0">Instandhaltungs- & Wartungsplaner</h1>
        <p class="text-muted small mb-0">Kalender, Erinnerungen und Protokollpflichten verwalten.</p>
    </div>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.dashboard') }}"><i class="bi bi-arrow-left"></i> Zurück</a>
</div>

<div class="card shadow-sm border-0 mb-3">
    <div class="card-body">
        <form class="row g-2 align-items-end" method="post" action="{{ url_for('main.create_maintenance_task') }}">
            <div class="col-lg-4">
                <label class="form-label">Titel</label>
                <input type="text" name="title" class="form-control" placeholder="z.B. Schornsteinfeger" required>
            </div>
            <div class="col-lg-2">
                <label class="form-label">Kategorie</label>
                <select name="category" class="form-select">
                    <option value="chimney">Schornsteinfeger</option>
                    <option value="legionella">Legionellenprüfung</option>
                    <option value="smoke">Rauchmelderwartung</option>
                    <option value="heating">Heizungswartung</option>
                    <option value="caretaker">Hausmeistertermin</option>
                    <option value="other">Sonstiges</option>
                </select>
            </div>
            <div class="col-lg-2">
                <label class="form-label">Datum</label>
                <input type="date" name="scheduled_on" class="form-control" required>
            </div>
            <div class="col-lg-2">
                <label class="form-label">Erinnerung (Tage)</label>
                <input type="number" name="reminder_days_before" class="form-control" value="7" min="0">
            </div>
            <div class="col-lg-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="open">Offen</option>
                    <option value="planned">Geplant</option>
                    <option value="done">Erledigt</option>
                </select>
            </div>
            <div class="col-lg-4">
                <label class="form-label">Vertrag (optional)</label>
                <select name="contract_id" class="form-select">
                    <option value="">—</option>
                    {% for contract in contracts %}
                    <option value="{{ contract.id }}">{{ contract.contract_number }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-4">
                <label class="form-label">Gebäude (optional)</label>
                <select name="building_id" class="form-select">
                    <option value="">—</option>
                    {% for building in buildings %}
                    <option value="{{ building.id }}">{{ building.name or building.address }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-4">
                <label class="form-label">Notiz</label>
                <input type="text" name="notes" class="form-control" placeholder="z.B. Zugangsschlüssel bereithalten">
            </div>
            <div class="col-12">
                <button class="btn btn-primary btn-sm"><i class="bi bi-plus-circle me-1"></i>Einplanen</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h6 class="mb-0">Kalender & Erinnerungen</h6>
                <small class="text-muted">Automatische Erinnerungsdaten und Protokollpflichten</small>
            </div>
            <form class="d-flex gap-2" method="get">
                <select class="form-select form-select-sm" name="status">
                    <option value="" {% if not status %}selected{% endif %}>Status: Alle</option>
                    <option value="open" {% if status=='open' %}selected{% endif %}>Offen</option>
                    <option value="planned" {% if status=='planned' %}selected{% endif %}>Geplant</option>
                    <option value="done" {% if status=='done' %}selected{% endif %}>Erledigt</option>
                </select>
                <select class="form-select form-select-sm" name="category">
                    <option value="" {% if not category %}selected{% endif %}>Kategorie: Alle</option>
                    <option value="chimney" {% if category=='chimney' %}selected{% endif %}>Schornsteinfeger</option>
                    <option value="legionella" {% if category=='legionella' %}selected{% endif %}>Legionellenprüfung</option>
                    <option value="smoke" {% if category=='smoke' %}selected{% endif %}>Rauchmelderwartung</option>
                    <option value="heating" {% if category=='heating' %}selected{% endif %}>Heizungswartung</option>
                    <option value="caretaker" {% if category=='caretaker' %}selected{% endif %}>Hausmeister</option>
                    <option value="other" {% if category=='other' %}selected{% endif %}>Sonstiges</option>
                </select>
                <button class="btn btn-outline-secondary btn-sm" type="submit">Filtern</button>
            </form>
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Termin</th>
                        <th>Kategorie</th>
                        <th>Erinnerung</th>
                        <th>Vertrag/Gebäude</th>
                        <th>Status</th>
                        <th class="text-end">Aktionen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>
                            <div class="fw-semibold">{{ task.title }}</div>
                            <div class="text-muted small">{{ task.scheduled_on.strftime('%d.%m.%Y') }}</div>
                        </td>
                        <td><span class="badge bg-light text-dark">{{ task.category }}</span></td>
                        <td class="small">
                            <div>ab {{ task.reminder_date.strftime('%d.%m.%Y') if task.reminder_date else '—' }}</div>
                            {% if task.protocol_required %}<div class="text-muted">Protokoll nötig</div>{% endif %}
                        </td>
                        <td class="small">
                            {% if task.contract %}<div>{{ task.contract.contract_number }}</div>{% endif %}
                            {% if task.building %}<div class="text-muted">{{ task.building.name or task.building.address }}</div>{% endif %}
                        </td>
                        <td>
                            {% if task.status == 'done' %}
                                <span class="badge bg-success">Erledigt</span>
                            {% elif task.status == 'planned' %}
                                <span class="badge bg-info text-dark">Geplant</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Offen</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#maintenanceModal" data-id="{{ task.id }}" data-title="{{ task.title }}" data-category="{{ task.category }}" data-scheduled="{{ task.scheduled_on.strftime('%Y-%m-%d') }}" data-reminder="{{ task.reminder_days_before }}" data-status="{{ task.status }}" data-notes="{{ task.notes or '' }}" data-contract="{{ task.contract_id or '' }}" data-building="{{ task.building_id or '' }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form method="post" action="{{ url_for('main.delete_maintenance_task', task_id=task.id) }}" class="d-inline">
                                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Termin löschen?')"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="6" class="text-center text-muted py-3">Keine Wartungstermine angelegt.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <nav class="mt-3">
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.maintenance_list', page=pagination.prev_num, status=status, category=category) }}">Zurück</a>
                </li>
                <li class="page-item disabled"><span class="page-link">Seite {{ pagination.page }} / {{ pagination.pages or 1 }}</span></li>
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.maintenance_list', page=pagination.next_num, status=status, category=category) }}">Weiter</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" method="post" id="maintenanceEditForm">
            <div class="modal-header">
                <h5 class="modal-title">Wartung bearbeiten</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-2">
                <div class="col-12">
                    <label class="form-label">Titel</label>
                    <input type="text" name="title" id="m_title" class="form-control" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Kategorie</label>
                    <select name="category" id="m_category" class="form-select">
                        <option value="chimney">Schornsteinfeger</option>
                        <option value="legionella">Legionellenprüfung</option>
                        <option value="smoke">Rauchmelderwartung</option>
                        <option value="heating">Heizungswartung</option>
                        <option value="caretaker">Hausmeistertermin</option>
                        <option value="other">Sonstiges</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">Status</label>
                    <select name="status" id="m_status" class="form-select">
                        <option value="open">Offen</option>
                        <option value="planned">Geplant</option>
                        <option value="done">Erledigt</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">Datum</label>
                    <input type="date" name="scheduled_on" id="m_date" class="form-control" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Erinnerungstage</label>
                    <input type="number" name="reminder_days_before" id="m_reminder" class="form-control" min="0">
                </div>
                <div class="col-12">
                    <label class="form-label">Vertrag (optional)</label>
                    <select name="contract_id" id="m_contract" class="form-select">
                        <option value="">—</option>
                        {% for contract in contracts %}
                        <option value="{{ contract.id }}">{{ contract.contract_number }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label">Gebäude (optional)</label>
                    <select name="building_id" id="m_building" class="form-select">
                        <option value="">—</option>
                        {% for building in buildings %}
                        <option value="{{ building.id }}">{{ building.name or building.address }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label">Notiz</label>
                    <textarea name="notes" id="m_notes" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="submit" class="btn btn-primary">Speichern</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('maintenanceModal');
    if (!modalEl) return;
    modalEl.addEventListener('show.bs.modal', (event) => {
        const trigger = event.relatedTarget;
        if (!trigger) return;
        const form = document.getElementById('maintenanceEditForm');
        form.action = `/maintenance/${trigger.dataset.id}/update`;
        document.getElementById('m_title').value = trigger.dataset.title || '';
        document.getElementById('m_category').value = trigger.dataset.category || 'other';
        document.getElementById('m_status').value = trigger.dataset.status || 'open';
        document.getElementById('m_date').value = trigger.dataset.scheduled || '';
        document.getElementById('m_reminder').value = trigger.dataset.reminder || 7;
        document.getElementById('m_notes').value = trigger.dataset.notes || '';
        document.getElementById('m_contract').value = trigger.dataset.contract || '';
        document.getElementById('m_building').value = trigger.dataset.building || '';
    });
});
</script>
{% endblock %}
