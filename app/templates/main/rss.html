{% extends "base.html" %}

{% block title %}RSS Feeds - MietAssistent{% endblock %}

{% block extra_css %}
<style>
    .rss-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.25rem;
        margin-top: 0.5rem;
    }
    .rss-content {
        color: #4b5563;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">
        <i class="bi bi-rss text-warning"></i> News & Updates
    </h1>
    <div class="btn-group">
        <a href="{{ url_for('rss.rss_items') }}" class="btn btn-outline-primary">
            <i class="bi bi-list-ul"></i> Alle Einträge
        </a>
        <a href="{{ url_for('rss.manage_feeds') }}" class="btn btn-outline-secondary">
            <i class="bi bi-gear"></i> Feeds verwalten
        </a>
    </div>
</div>

<div class="row">
    <!-- Feed-Übersicht -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="bi bi-collection"></i> Meine Feeds
                </h5>
            </div>
            <div class="card-body">
                {% if feeds %}
                <div class="list-group list-group-flush">
                    {% for feed in feeds %}
                    <a href="{{ url_for('rss.rss_items') }}?feed_id={{ feed.id }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ feed.name }}</h6>
                            <small class="text-muted">{{ feed.category }}</small>
                        </div>
                        {% if feed.unread_count > 0 %}
                        <span class="badge bg-primary rounded-pill">{{ feed.unread_count }}</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-rss display-6 text-muted"></i>
                    <p class="text-muted mt-2">Keine Feeds konfiguriert</p>
                    <a href="{{ url_for('rss.add_feed') }}" class="btn btn-primary btn-sm">Feed hinzufügen</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Aktuelle Nachrichten -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock"></i> Neueste Nachrichten
                </h5>
                {% if recent_items %}
                <form method="POST" action="{{ url_for('rss.mark_all_read') }}" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-check-all"></i> Alle lesen
                    </button>
                </form>
                {% endif %}
            </div>
            <div class="card-body">
                {% if recent_items %}
                <div class="list-group list-group-flush">
                    {% for item in recent_items %}
                    <div class="list-group-item px-0">
                        <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                            <h6 class="mb-1">
                                <a href="{{ item.link }}" target="_blank" class="text-decoration-none" title="{{ item.title }}">
                                    {{ item.title|truncate(80) }}
                                </a>
                                {% if not item.is_read %}
                                <span class="badge bg-primary ms-2">Neu</span>
                                {% endif %}
                                {% if item.is_starred %}
                                <span class="badge bg-warning ms-1"><i class="bi bi-star-fill"></i></span>
                                {% endif %}
                            </h6>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary btn-sm toggle-star" 
                                        data-item-id="{{ item.id }}"
                                        title="{% if item.is_starred %}Favorit entfernen{% else %}Als Favorit markieren{% endif %}">
                                    <i class="bi {% if item.is_starred %}bi-star-fill text-warning{% else %}bi-star{% endif %}"></i>
                                </button>
                                {% if not item.is_read %}
                                <button class="btn btn-outline-primary btn-sm mark-read" 
                                        data-item-id="{{ item.id }}"
                                        title="Als gelesen markieren">
                                    <i class="bi bi-check"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-2 small rss-content">{{ item.description|safe }}</div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">
                                <i class="bi bi-tag"></i> {{ item.feed.name }}
                            </small>
                            <small class="text-muted">{{ item.published_date.strftime('%d.%m.%Y %H:%M') }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-3">Keine Nachrichten verfügbar</p>
                    <a href="{{ url_for('rss.manage_feeds') }}" class="btn btn-primary">Feeds aktualisieren</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Als gelesen markieren
    document.querySelectorAll('.mark-read').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const button = this;
            
            fetch(`{{ url_for('rss.mark_item_read', item_id='') }}${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // Entferne "Neu" Badge und Mark-Read Button
                      const listItem = button.closest('.list-group-item');
                      listItem.querySelector('.badge.bg-primary')?.remove();
                      button.remove();
                  }
              });
        });
    });

    // Favorit umschalten
    document.querySelectorAll('.toggle-star').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const icon = this.querySelector('i');
            
            fetch(`{{ url_for('rss.toggle_item_star', item_id='') }}${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      if (data.is_starred) {
                          icon.classList.remove('bi-star');
                          icon.classList.add('bi-star-fill', 'text-warning');
                      } else {
                          icon.classList.remove('bi-star-fill', 'text-warning');
                          icon.classList.add('bi-star');
                      }
                  }
              });
        });
    });
});
</script>
{% endblock %}