<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="static/css/contract_pdf.css">
</head>
<body class="contract-body">
    {% set landlord = contract.landlord if contract else None %}
    {% set landlord_name = (landlord.company_name or ((landlord.first_name or '') ~ ' ' ~ (landlord.last_name or '')))|trim if landlord else '' %}
    {% set tenant = contract.tenant if contract else None %}
    {% set tenant_name = ((tenant.first_name or '') ~ ' ' ~ (tenant.last_name or ''))|trim if tenant else '' %}
    <h1 class="main-title">Protokoll {{ protocol.protocol_type|replace('ueber','√úber')|replace('rueck','R√ºck') }}</h1>
    <section class="meta-grid">
        <div>
            <div class="label">Datum</div>
            <div class="value">{{ protocol.protocol_date.strftime('%d.%m.%Y') }}</div>
        </div>
        {% if contract %}
        <div>
            <div class="label">Vertrag</div>
            <div class="value">{{ contract.contract_number }}</div>
        </div>
        {% endif %}
        <div>
            <div class="label">Typ</div>
            <div class="value">{{ protocol.protocol_type }}</div>
        </div>
    </section>
    <div class="divider"></div>

    <section class="clause">
        <div class="clause-title">Zustand / R√§ume</div>
        <div class="info-box box-large">{{ protocol_data.condition_summary or '' }}</div>
    </section>

    <section class="clause">
        <div class="clause-title">Schl√ºssel (gesamt {{ protocol_data.key_count or (keys|length) or 0 }})</div>
        {% if keys %}
        <table class="table table-keys-grid">
            <tbody>
                {% for row in keys|batch(4, fill_with=None) %}
                <tr>
                    {% for key in row %}
                    <td class="key-grid-cell">
                        {% if key %}
                        <div class="key-card-compact">
                            <div class="key-card-header">
                                <div class="value">{{ key.title or 'Schl√ºssel ' ~ ((loop.parentloop.index0 * 4) + loop.index) }}</div>
                                <span class="key-qty-chip">{{ key.quantity or 1 }}√ó</span>
                            </div>
                            <div class="key-card-body">
                                <div class="muted">{{ key.location or 'Ort unbekannt' }}</div>
                                {% if key.description %}<div class="key-card-notes">{{ key.description }}</div>{% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="info-box">Keine Schl√ºsselangaben hinterlegt.</div>
        {% endif %}
    </section>

    <section class="clause">
        <div class="clause-title">Inventar / Ausstattung</div>
        {% if inventory_entries %}
        <table class="table">
            <thead>
                <tr>
                    <th>Bezeichnung</th>
                    <th>Raum</th>
                    <th>Zustand</th>
                    <th>Menge</th>
                    <th>Sch√§den / Notizen</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory_entries %}
                <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.location or '' }}</td>
                    <td>{{ item.condition or '' }}</td>
                    <td style="text-align:right;">{{ item.quantity or 1 }}</td>
                    <td>
                        <div style="color:#b91c1c;">{{ item.damages or '' }}</div>
                        <div class="value">{{ item.notes or '' }}</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="info-box">Keine Inventardaten hinterlegt.</div>
        {% endif %}
    </section>

    <section class="clause">
        <div class="clause-title">Z√§hlerst√§nde</div>
        {% if meter_entries %}
        <table class="table">
            <thead>
                <tr>
                    <th>Typ</th>
                    <th>Nummer</th>
                    <th>Ort</th>
                    <th>Wert</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in meter_entries %}
                <tr>
                    <td>{{ entry.type }} {{ '(' ~ entry.unit ~ ')' if entry.unit }}</td>
                    <td>{{ entry.number }}</td>
                    <td>{{ entry.location or '' }}</td>
                    <td>{{ entry.reading_value or '' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="info-box">Keine Z√§hlerst√§nde erfasst.</div>
        {% endif %}
    </section>

    <section class="clause">
        <div class="clause-title">Z√§hlerst√§nde / Hinweise</div>
        <div class="info-box box-large">{{ protocol_data.meter_notes or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">Raum- / Checklisten-Notizen</div>
        <div class="info-box box-large">{{ protocol_data.room_notes or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">Sch√§den / Beanstandungen</div>
        <div class="info-box box-large">{{ protocol_data.damages or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">Abweichungen / R√ºcknahme</div>
        <div class="info-box box-large">{{ protocol_data.return_notes or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">Notizen</div>
        <div class="info-box box-large">{{ protocol_data.notes or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">√úbergabevermerke</div>
        <div class="info-box box-large">{{ protocol_data.handover_notes or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">Nacharbeiten / To-dos</div>
        <div class="info-box box-large">{{ protocol_data.follow_up_notes or '' }}</div>
    </section>
    <section class="clause">
        <div class="clause-title">Einverst√§ndniserkl√§rung</div>
        <div class="legal-box">
            Mit den oben dokumentierten Zust√§nden, Z√§hlerst√§nden und √ºbergebenen bzw. zur√ºckgenommenen Gegenst√§nden sind beide Parteien einverstanden. Abweichungen wurden festgehalten. √Ñnderungen nach Unterzeichnung bed√ºrfen einer gesonderten schriftlichen Vereinbarung.
        </div>
    </section>
    <section class="signature-block">
        <p class="label">Ort, Datum</p>
        <div class="signature-date-line"></div>
        <div class="signature-row">
            <div class="sig-cell">
                <div class="sig-line"></div>
                <div class="sig-label">Unterschrift Vermieter</div>
                <div class="sig-name">{{ landlord_name }}</div>
            </div>
            <div class="sig-cell">
                <div class="sig-line"></div>
                <div class="sig-label">Unterschrift Mieter</div>
                <div class="sig-name">{{ tenant_name }}</div>
            </div>
        </div>
    </section>
    {% set attachments = attachment_entries if attachment_entries is defined else (protocol_data.attachments if protocol_data else []) %}
    {% if attachments %}
    <div class="page-break"></div>
    <section class="clause clause-attachments">
        <div class="clause-title">Anlagen</div>
        <p class="attachment-note">Die folgenden Dateien sind Bestandteil des Protokolls.</p>
    </section>
    <div class="attachments-wrapper">
        {% for att in attachments %}
        <div class="attachment-card">
            <div class="attachment-header">
                <div class="attachment-caption">Anlage {{ loop.index }}{% if att.caption %}: {{ att.caption }}{% endif %}</div>
                <div class="attachment-filename">{{ att.file }}</div>
            </div>
            {% if att.is_image and (att.image_data_uri or att.local_path) %}
            <div class="attachment-media">
                <img src="{{ att.image_data_uri or att.local_path }}" alt="Anlage {{ loop.index }}" class="attachment-image">
            </div>
            {% else %}
            <div class="attachment-filebox">
                <div class="file-icon">üìÑ</div>
                <div>
                    <div class="file-name">{{ att.caption or att.file }}</div>
                    <div class="file-meta text-muted">{{ att.mime or 'Datei' }}</div>
                </div>
            </div>
            {% endif %}
        </div>
        {% if not loop.last %}<div class="page-break attachment-break"></div>{% endif %}
        {% endfor %}
    </div>
    {% endif %}
</body>
</html>
