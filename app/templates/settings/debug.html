{% extends "base.html" %}

{% block title %}Admin-Debug - MietAssistent{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0"><i class="bi bi-bug text-danger me-2"></i>Debug / Risiko-Bereich</h1>
    <a href="{{ url_for('settings_web.settings_home') }}" class="btn btn-outline-secondary btn-sm">Zurück zu Einstellungen</a>
</div>
<div class="alert alert-warning">
    <strong>Achtung:</strong> Änderungen hier werden sofort und revisionsfrei gespeichert. Nur für Administratoren gedacht.
</div>

<ul class="nav nav-tabs" id="debugTabs" role="tablist">
    {% for key, label in [('meters','Zähler'),('meter_readings','Zählerstände'),('buildings','Gebäude'),('apartments','Wohnungen'),('tenants','Mieter'),('users','Benutzer'),('contracts','Verträge')] %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == key %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#tab-{{ key }}" type="button" role="tab">{{ label }}</button>
    </li>
    {% endfor %}
</ul>

<div class="tab-content mt-3">
    <div class="tab-pane fade {% if active_tab == 'meters' %}show active{% endif %}" id="tab-meters" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Nummer</th><th>Beschreibung</th><th>Parent</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for meter in entities.meters %}
                    <tr>
                        <td><code>{{ meter.id }}</code></td>
                        <td colspan="3">
                            <div class="row g-2 align-items-center">
                                <form class="col-md-10 row g-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='meters', record_id=meter.id) }}">
                                    <div class="col-md-4"><input class="form-control form-control-sm" name="meter_number" value="{{ meter.meter_number }}"></div>
                                    <div class="col-md-4"><input class="form-control form-control-sm" name="description" value="{{ meter.description or '' }}" placeholder="Beschreibung"></div>
                                    <div class="col-md-4"><input class="form-control form-control-sm" name="parent_meter_id" value="{{ meter.parent_meter_id or '' }}" placeholder="Parent-ID (leer = Hauptzähler)"></div>
                                    <div class="col-12 mt-1">
                                        <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                                    </div>
                                </form>
                                <div class="col-md-2">
                                    <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='meters', record_id=meter.id) }}" onsubmit="return confirm('Diesen Zähler endgültig löschen?');">
                                        <button class="btn btn-outline-danger btn-sm w-100" type="submit">Löschen</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'meter_readings' %}show active{% endif %}" id="tab-meter_readings" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Zähler</th><th>Wert</th><th>Datum</th><th>Notiz</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for reading in entities.meter_readings %}
                    <tr>
                        <td><code>{{ reading.id }}</code></td>
                        <td>{{ reading.meter.meter_number if reading.meter else '-' }}</td>
                        <td>
                            <form class="d-flex gap-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='meter_readings', record_id=reading.id) }}">
                                <input class="form-control form-control-sm" name="reading_value" value="{{ reading.reading_value }}" style="max-width:120px;">
                                <input class="form-control form-control-sm" name="notes" value="{{ reading.notes or '' }}" placeholder="Notiz">
                                <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                            </form>
                        </td>
                        <td>{{ reading.reading_date }}</td>
                        <td>{{ reading.notes or '' }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='meter_readings', record_id=reading.id) }}" onsubmit="return confirm('Zählerstand löschen?');">
                                <button class="btn btn-outline-danger btn-sm" type="submit">Löschen</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'buildings' %}show active{% endif %}" id="tab-buildings" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Name</th><th>Straße</th><th>Stadt</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for building in entities.buildings %}
                    <tr>
                        <td><code>{{ building.id }}</code></td>
                        <td colspan="3">
                            <div class="row g-2 align-items-center">
                                <form class="col-md-10 row g-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='buildings', record_id=building.id) }}">
                                    <div class="col-md-4"><input class="form-control form-control-sm" name="name" value="{{ building.name }}"></div>
                                    <div class="col-md-4"><input class="form-control form-control-sm" name="street" value="{{ building.street or '' }}" placeholder="Straße"></div>
                                    <div class="col-md-4"><input class="form-control form-control-sm" name="city" value="{{ building.city or '' }}" placeholder="Stadt"></div>
                                    <div class="col-12 mt-1">
                                        <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                                    </div>
                                </form>
                                <div class="col-md-2">
                                    <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='buildings', record_id=building.id) }}" onsubmit="return confirm('Gebäude löschen?');">
                                        <button class="btn btn-outline-danger btn-sm w-100" type="submit">Löschen</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'apartments' %}show active{% endif %}" id="tab-apartments" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Nummer</th><th>Etage</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for apartment in entities.apartments %}
                    <tr>
                        <td><code>{{ apartment.id }}</code></td>
                        <td colspan="2">
                            <div class="row g-2 align-items-center">
                                <form class="col-md-9 row g-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='apartments', record_id=apartment.id) }}">
                                    <div class="col-md-6"><input class="form-control form-control-sm" name="apartment_number" value="{{ apartment.apartment_number }}"></div>
                                    <div class="col-md-6"><input class="form-control form-control-sm" name="floor" value="{{ apartment.floor or '' }}" placeholder="Etage"></div>
                                    <div class="col-12 mt-1">
                                        <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                                    </div>
                                </form>
                                <div class="col-md-3">
                                    <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='apartments', record_id=apartment.id) }}" onsubmit="return confirm('Wohnung löschen?');">
                                        <button class="btn btn-outline-danger btn-sm w-100" type="submit">Löschen</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'tenants' %}show active{% endif %}" id="tab-tenants" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Name</th><th>Kontakt</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for tenant in entities.tenants %}
                    <tr>
                        <td><code>{{ tenant.id }}</code></td>
                        <td colspan="2">
                            <div class="row g-2 align-items-center">
                                <form class="col-md-10 row g-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='tenants', record_id=tenant.id) }}">
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="first_name" value="{{ tenant.first_name }}"></div>
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="last_name" value="{{ tenant.last_name }}"></div>
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="email" value="{{ tenant.email or '' }}" placeholder="E-Mail"></div>
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="phone" value="{{ tenant.phone or '' }}" placeholder="Telefon"></div>
                                    <div class="col-12 mt-1">
                                        <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                                    </div>
                                </form>
                                <div class="col-md-2">
                                    <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='tenants', record_id=tenant.id) }}" onsubmit="return confirm('Mieter löschen?');">
                                        <button class="btn btn-outline-danger btn-sm w-100" type="submit">Löschen</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'users' %}show active{% endif %}" id="tab-users" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Name</th><th>Rolle</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for user in entities.users %}
                    <tr>
                        <td><code>{{ user.id }}</code></td>
                        <td colspan="2">
                            <div class="row g-2 align-items-center">
                                <form class="col-md-10 row g-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='users', record_id=user.id) }}">
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="first_name" value="{{ user.first_name }}"></div>
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="last_name" value="{{ user.last_name }}"></div>
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="email" value="{{ user.email }}"></div>
                                    <div class="col-md-3"><input class="form-control form-control-sm" name="role" value="{{ user.role }}"></div>
                                    <div class="col-12 mt-1">
                                        <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                                    </div>
                                </form>
                                <div class="col-md-2">
                                    <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='users', record_id=user.id) }}" onsubmit="return confirm('Benutzer löschen?');">
                                        <button class="btn btn-outline-danger btn-sm w-100" type="submit">Löschen</button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade {% if active_tab == 'contracts' %}show active{% endif %}" id="tab-contracts" role="tabpanel">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Nummer</th><th>Status</th><th>Aktion</th></tr></thead>
                <tbody>
                {% for contract in entities.contracts %}
                    <tr>
                        <td><code>{{ contract.id }}</code></td>
                        <td>{{ contract.contract_number }}</td>
                        <td>
                            <form class="d-flex gap-2" method="POST" action="{{ url_for('settings_web.update_debug_record', entity='contracts', record_id=contract.id) }}">
                                <input class="form-control form-control-sm" name="status" value="{{ contract.status }}" style="max-width:180px;">
                                <button class="btn btn-primary btn-sm" type="submit">Speichern</button>
                            </form>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('settings_web.delete_debug_record', entity='contracts', record_id=contract.id) }}" onsubmit="return confirm('Vertrag löschen?');">
                                <button class="btn btn-outline-danger btn-sm" type="submit">Löschen</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
