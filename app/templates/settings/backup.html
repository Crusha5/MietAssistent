{% extends 'base.html' %}
{% block title %}Backup & Wiederherstellung{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Backup &amp; Wiederherstellung</h1>
        <p class="text-muted mb-0">Sichere deine Datenbank und Uploads oder stelle ein vollständiges Backup wieder her.</p>
    </div>
    <span class="badge text-bg-secondary"><i class="bi bi-shield-lock me-1"></i>Admin Bereich</span>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="feature-icon me-3"><i class="bi bi-cloud-download"></i></div>
                    <div>
                        <h5 class="mb-1">Backup Exportieren</h5>
                        <small class="text-muted">Erstellt ein vollständiges ZIP der Uploads und Datenbank.</small>
                    </div>
                </div>
                <ul class="mb-3 small text-muted">
                    <li>Alle Uploads, PDF-Generierungen &amp; Protokollbilder</li>
                    <li>SQLite-Datenbank mit Metadaten</li>
                    <li>Serverseitige Erstellung ohne Shell-Befehle</li>
                </ul>
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <span>Der Export läuft serverseitig. Du kannst den Fortschritt live verfolgen.</span>
                </div>
                <div class="mb-3">
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar" id="exportProgressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2 small text-muted">
                        <span id="exportStatus">Bereit</span>
                        <span id="exportPercent">0%</span>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="exportBackupBtn"><i class="bi bi-cloud-download me-1"></i>Backup exportieren</button>
                    <a class="btn btn-outline-success d-none" id="exportDownloadBtn" href="#" target="_blank"><i class="bi bi-download me-1"></i>Download</a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="feature-icon me-3 bg-warning text-dark"><i class="bi bi-cloud-upload"></i></div>
                    <div>
                        <h5 class="mb-1">Backup Importieren</h5>
                        <small class="text-muted">Stellt den vollständigen Systemzustand aus einer ZIP wieder her.</small>
                    </div>
                </div>
                <div class="alert alert-warning" role="alert">
                    <strong>Warnung:</strong> Beim Import werden alle aktuellen Daten überschrieben. Dieser Vorgang kann nicht rückgängig gemacht werden.
                </div>
                <div class="mb-3">
                    <label for="importFile" class="form-label">Backup-ZIP auswählen</label>
                    <input class="form-control" type="file" id="importFile" accept=".zip">
                    <small class="text-muted">Erforderlich: Verzeichnisse <code>uploads/</code> und <code>data/</code> im Archiv.</small>
                </div>
                <div class="mb-3">
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar bg-success" id="importProgressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2 small text-muted">
                        <span id="importStatus">Bereit</span>
                        <span id="importPercent">0%</span>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-success" id="importBackupBtn"><i class="bi bi-cloud-upload me-1"></i>Backup importieren</button>
                    <span class="small text-muted" id="importHint">Validierung erfolgt serverseitig.</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="restartModal" tabindex="-1" aria-labelledby="restartModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="restartModalLabel">System neu starten?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Backup erfolgreich importiert. Möchten Sie das System jetzt neu starten?</p>
        <small class="text-muted">Der Neustart stellt sicher, dass Datenbank und Uploads vollständig neu geladen werden.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Nein</button>
        <button type="button" class="btn btn-primary" id="confirmRestartBtn">Ja, jetzt neu starten</button>
      </div>
    </div>
  </div>
</div>

<script>
    const exportBtn = document.getElementById('exportBackupBtn');
    const exportProgressBar = document.getElementById('exportProgressBar');
    const exportStatus = document.getElementById('exportStatus');
    const exportPercent = document.getElementById('exportPercent');
    const exportDownloadBtn = document.getElementById('exportDownloadBtn');

    const importBtn = document.getElementById('importBackupBtn');
    const importFile = document.getElementById('importFile');
    const importProgressBar = document.getElementById('importProgressBar');
    const importStatus = document.getElementById('importStatus');
    const importPercent = document.getElementById('importPercent');
    const importHint = document.getElementById('importHint');
    const restartModal = new bootstrap.Modal(document.getElementById('restartModal'));
    const restartBtn = document.getElementById('confirmRestartBtn');

    let exportJobId = null;
    let exportPoll = null;
    let importJobId = null;
    let importPoll = null;

    function updateProgress(bar, percentEl, statusEl, value, statusText) {
        const safeVal = Math.min(100, Math.max(0, value || 0));
        bar.style.width = `${safeVal}%`;
        bar.setAttribute('aria-valuenow', safeVal);
        percentEl.textContent = `${safeVal}%`;
        if (statusText) {
            statusEl.textContent = statusText;
        }
    }

    function handleExportStatus(payload) {
        updateProgress(exportProgressBar, exportPercent, exportStatus, payload.progress, payload.message || '...');
        if (payload.status === 'completed') {
            clearInterval(exportPoll);
            exportStatus.textContent = 'Backup erfolgreich erstellt';
            exportDownloadBtn.classList.remove('d-none');
            exportDownloadBtn.href = `{{ url_for('settings_web.backup_export_download', job_id='__JOB__') }}`.replace('__JOB__', exportJobId);
            exportBtn.disabled = false;
        } else if (payload.status === 'error') {
            clearInterval(exportPoll);
            exportStatus.textContent = payload.error || 'Fehler beim Export';
            exportBtn.disabled = false;
        }
    }

    function startExport() {
        exportBtn.disabled = true;
        exportDownloadBtn.classList.add('d-none');
        updateProgress(exportProgressBar, exportPercent, exportStatus, 0, 'Backup wird erstellt...');
        fetch('{{ url_for('settings_web.start_backup_export') }}', {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    exportStatus.textContent = data.error;
                    exportBtn.disabled = false;
                    return;
                }
                exportJobId = data.job_id;
                exportPoll = setInterval(() => {
                    fetch(`{{ url_for('settings_web.backup_export_status') }}?job_id=${exportJobId}`)
                        .then(r => r.json())
                        .then(handleExportStatus)
                        .catch(() => {
                            exportStatus.textContent = 'Fortschritt konnte nicht gelesen werden';
                        });
                }, 1000);
            })
            .catch(() => {
                exportStatus.textContent = 'Export konnte nicht gestartet werden';
                exportBtn.disabled = false;
            });
    }

    function handleImportStatus(payload) {
        updateProgress(importProgressBar, importPercent, importStatus, payload.progress, payload.message || '...');
        if (payload.status === 'completed') {
            clearInterval(importPoll);
            importStatus.textContent = 'Backup erfolgreich importiert';
            importBtn.disabled = false;
            if (payload.restart_required) {
                restartModal.show();
            }
        } else if (payload.status === 'error') {
            clearInterval(importPoll);
            importStatus.textContent = payload.error || 'Fehler beim Import';
            importBtn.disabled = false;
        }
    }

    function startImport() {
        if (!importFile.files.length) {
            importStatus.textContent = 'Bitte eine ZIP-Datei auswählen.';
            return;
        }
        importBtn.disabled = true;
        updateProgress(importProgressBar, importPercent, importStatus, 0, 'Validierung...');

        const formData = new FormData();
        formData.append('file', importFile.files[0]);

        fetch('{{ url_for('settings_web.start_backup_import') }}', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    importStatus.textContent = data.error;
                    importBtn.disabled = false;
                    return;
                }
                importJobId = data.job_id;
                importPoll = setInterval(() => {
                    fetch(`{{ url_for('settings_web.backup_import_status') }}?job_id=${importJobId}`)
                        .then(r => r.json())
                        .then(handleImportStatus)
                        .catch(() => {
                            importStatus.textContent = 'Fortschritt konnte nicht gelesen werden';
                        });
                }, 1000);
            })
            .catch(() => {
                importStatus.textContent = 'Import konnte nicht gestartet werden';
                importBtn.disabled = false;
            });
    }

    function confirmRestart() {
        restartBtn.disabled = true;
        restartBtn.textContent = 'Neustart wird ausgelöst...';
        fetch('{{ url_for('settings_web.trigger_backup_restart') }}', {method: 'POST'})
            .finally(() => {
                restartBtn.textContent = 'Ja, jetzt neu starten';
                restartBtn.disabled = false;
                restartModal.hide();
            });
    }

    exportBtn.addEventListener('click', startExport);
    importBtn.addEventListener('click', startImport);
    restartBtn.addEventListener('click', confirmRestart);
</script>
{% endblock %}
