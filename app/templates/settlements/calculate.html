{% extends "base.html" %}

{% block title %}Abrechnung erstellen - Rental Management{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator me-2"></i>Abrechnung erstellen
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" action="/settlements/calculate" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="apartment_id" class="form-label">Wohnung *</label>
                            <select class="form-select" id="apartment_id" name="apartment_id" required>
                                <option value="">Bitte auswählen...</option>
                                {% for apartment in apartments %}
                                <option value="{{ apartment.id }}" {% if selected_apartment and apartment.id == selected_apartment.id %}selected{% endif %}>{{ apartment.get_full_identifier() }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="period_start" class="form-label">Abrechnungszeitraum Start *</label>
                            <input type="date" class="form-control" id="period_start" name="period_start" value="{{ default_start.strftime('%Y-%m-%d') if default_start else '' }}" required>
                        </div>

                        <div class="col-md-6">
                            <label for="period_end" class="form-label">Abrechnungszeitraum Ende *</label>
                            <input type="date" class="form-control" id="period_end" name="period_end" value="{{ default_end.strftime('%Y-%m-%d') if default_end else '' }}" required>
                        </div>
                    </div>

                    <div class="mt-3 d-flex align-items-center gap-2">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-search me-1"></i>Vorschau aktualisieren
                        </button>
                        <a href="/settlements" class="btn btn-outline-secondary">Abbrechen</a>
                    </div>
                </form>

                {% if selected_apartment %}
                <div class="alert alert-info small">
                    Die Abrechnung verwendet automatisch den aktiven Vertrag der Wohnung sowie alle umlagefähigen Kosten im gewählten Zeitraum (01.01–31.12 bzw. bis Auszug).
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100">
                            <h6 class="text-primary">Vertragsdaten</h6>
                            {% if contract %}
                                <div class="fw-bold">Nr. {{ contract.contract_number }}</div>
                                <div>Laufzeit: {{ contract.start_date.strftime('%d.%m.%Y') }}{% if contract.end_date %} – {{ contract.end_date.strftime('%d.%m.%Y') }}{% endif %}</div>
                                <div>Wohnfläche: {{ '%.2f'|format(contract.floor_space or selected_apartment.area_sqm or 0) }} m²</div>
                                <div>Vorauszahlung (BK/HZ): {{ '%.2f'|format(contract.get_monthly_operating_prepayment() or 0) }} € / Monat</div>
                                <div>Mieter: {{ contract.tenant.first_name }} {{ contract.tenant.last_name }}</div>
                            {% else %}
                                <div class="text-muted">Kein aktiver Vertrag gefunden.</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded p-3 h-100">
                            <h6 class="text-primary">Objekt</h6>
                            <div>{{ selected_apartment.get_full_identifier() }}</div>
                            {% if selected_apartment.building %}
                                <div>{{ selected_apartment.building.street }} {{ selected_apartment.building.street_number }}</div>
                                <div>{{ selected_apartment.building.zip_code }} {{ selected_apartment.building.city }}</div>
                            {% endif %}
                            <div>Gesamtfläche Gebäude: {{ '%.2f'|format(building_area or 0) }} m²</div>
                        </div>
                    </div>
                </div>

                {% if preview %}
                <div class="border rounded p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Vorschau Kosten & Verbrauch</h6>
                        <span class="badge bg-secondary">ohne Speicherung</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Kostenart</th>
                                    <th>Zeitraum/Beleg</th>
                                    <th>Umlage</th>
                                    <th class="text-end">Gesamt</th>
                                    <th class="text-end">Anteil</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in preview.cost_breakdown or [] %}
                                <tr>
                                    <td>{{ row.category }}</td>
                                    <td>
                                        {% if row.invoice_number %}Rechnung: {{ row.invoice_number }}<br>{% endif %}
                                        {% if row.billing_period %}{{ row.billing_period }}{% endif %}
                                    </td>
                                    <td>{{ row.basis or row.method }}</td>
                                    <td class="text-end">{{ '%.2f'|format(row.amount_total or 0) }} €</td>
                                    <td class="text-end">{{ '%.2f'|format(row.share or 0) }} €</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="text-muted">Keine umlagefähigen Kosten im Zeitraum.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4"><strong>Gesamtkostenanteil:</strong> {{ '%.2f'|format(preview.total_costs or 0) }} €</div>
                        <div class="col-md-4"><strong>Vorauszahlungen:</strong> {{ '%.2f'|format(preview.advance_payments or 0) }} €</div>
                        <div class="col-md-4"><strong>Saldo:</strong> {{ '%.2f'|format(preview.balance or 0) }} €</div>
                    </div>
                </div>

                <form method="POST" action="/settlements/calculate">
                    <input type="hidden" name="apartment_id" value="{{ selected_apartment.id }}">
                    <input type="hidden" name="period_start" value="{{ default_start.strftime('%Y-%m-%d') if default_start else '' }}">
                    <input type="hidden" name="period_end" value="{{ default_end.strftime('%Y-%m-%d') if default_end else '' }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">Abrechnung wird gespeichert, PDF erzeugt und dem Vertrag zugeordnet.</div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Abrechnung erstellen
                        </button>
                    </div>
                </form>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}