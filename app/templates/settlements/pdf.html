<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Nebenkostenabrechnung</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settlement_pdf.css') }}">
</head>
<body>
    {% set contract_data = contract if contract else settlement.contract_snapshot %}
    {% if contract %}
        {% set landlord_data = landlord or contract.landlord %}
    {% else %}
        {% set landlord_data = landlord or (contract_data and contract_data.get('landlord')) %}
    {% endif %}

    {% set landlord_company = (landlord_data.company_name or landlord_data.company) if landlord_data else '' %}
    {% set landlord_personal = ((landlord_data.first_name or '') ~ ' ' ~ (landlord_data.last_name or '')).strip() if landlord_data else '' %}
    {% set landlord_display_name = (landlord_data.name or landlord_personal) if landlord_data else '' %}
    {% set balance_val = settlement.balance or 0 %}
    {% set balance_abs = balance_val | abs %}

    <div class="letter-block">
        <div class="sender-info">
            {% if landlord_company %}{{ landlord_company }}<br>{% endif %}
            {% if landlord_display_name and landlord_display_name != landlord_company %}{{ landlord_display_name }}<br>{% endif %}
            {% if landlord_data %}
                {{ landlord_data.street or '' }} {{ landlord_data.street_number or '' }}<br>
                {{ landlord_data.zip_code or '' }} {{ landlord_data.city or '' }}<br>
                {% if landlord_data.phone %}Tel.: {{ landlord_data.phone }}<br>{% endif %}
                {% if landlord_data.email %}E-Mail: {{ landlord_data.email }}{% endif %}
            {% endif %}
        </div>

        <div class="address-window">
            {% if landlord_company %}<div class="sender-line">{{ landlord_company }}</div>{% endif %}
            {% if landlord_display_name and landlord_display_name != landlord_company %}<div class="sender-line">{{ landlord_display_name }}</div>{% endif %}
            <div class="recipient">
                {% if tenant %}
                    {{ tenant.first_name }} {{ tenant.last_name }}<br>
                {% elif contract_data and contract_data.tenant_name %}
                    {{ contract_data.tenant_name }}<br>
                {% endif %}
                {% if building %}
                    {{ building.street }} {{ building.street_number }}<br>
                    {{ building.zip_code }} {{ building.city }}
                {% elif contract_data and contract_data.building_address %}
                    {{ contract_data.building_address }}
                {% endif %}
            </div>
        </div>

        <div class="letter-meta">
            <div>{{ building.city if building else (landlord_data.city if landlord_data else '') }}, {{ generated_at.strftime('%d.%m.%Y') if generated_at else '' }}</div>
        </div>

        <div class="letter-body">
            <p class="subject"><strong>Nebenkostenabrechnung {{ settlement.period_start.strftime('%d.%m.%Y') }} bis {{ settlement.period_end.strftime('%d.%m.%Y') }}</strong></p>
            <p class="paragraph-gap spacer-row"></p>
            <p class="paragraph-gap">Guten Tag{% if tenant %} {{ tenant.first_name }} {{ tenant.last_name }}{% endif %},</p>
            <p class="paragraph-gap">anbei erhalten Sie die Nebenkostenabrechnung für Ihre Wohnung im oben genannten Zeitraum. Wir haben die Kosten transparent aufbereitet und die Vorauszahlungen berücksichtigt.</p>
            <p class="paragraph-gap spacer-row"></p>
            {% if balance_val > 0.01 %}
                <p class="paragraph-gap">Es ergibt sich eine Nachzahlung in Höhe von {{ '%.2f'|format(balance_abs) }} €. Bitte überweisen Sie den Betrag innerhalb von 14 Tagen auf die unten stehende Bankverbindung.</p>
            {% elif balance_val < -0.01 %}
                <p class="paragraph-gap">Zu Ihren Gunsten entsteht ein Guthaben in Höhe von {{ '%.2f'|format(balance_abs) }} €. Wir erstatten den Betrag zeitnah auf die hinterlegte Bankverbindung. Teilen Sie uns bitte eine Kontoverbindung mit, falls wir noch keine haben.</p>
            {% else %}
                <p class="paragraph-gap">Die Abrechnung ist ausgeglichen. Ein Zahlungsbedarf besteht derzeit nicht.</p>
            {% endif %}
            <p class="paragraph-gap spacer-row"></p>
            <p class="paragraph-gap">Bitte prüfen Sie die Aufstellung in Ruhe. Bei Rückfragen stehen wir Ihnen gerne zur Verfügung.</p>
            <p class="paragraph-gap spacer-row"></p>
            <p class="paragraph-gap">Mit freundlichen Grüßen</p>
        </div>
    </div>
    <div class="header page-break-before">
        <div>
            <h1>Nebenkostenabrechnung</h1>
            <div>Abrechnungszeitraum: {{ settlement.period_start.strftime('%d.%m.%Y') }} - {{ settlement.period_end.strftime('%d.%m.%Y') }}</div>
            <div>Erstellt am: {{ generated_at.strftime('%d.%m.%Y') if generated_at else '' }}</div>
        </div>
        <div>
            <strong>Vermieter</strong><br>
            {% if landlord_data %}
                {% if landlord_company %}{{ landlord_company }}<br>{% endif %}
                {% if landlord_display_name and landlord_display_name != landlord_company %}{{ landlord_display_name }}<br>{% endif %}
                {{ landlord_data.street or '' }} {{ landlord_data.street_number or '' }}<br>
                {{ landlord_data.zip_code or '' }} {{ landlord_data.city or '' }}<br>
                {% if landlord_data.phone %}Tel.: {{ landlord_data.phone }}<br>{% endif %}
                {% if landlord_data.email %}E-Mail: {{ landlord_data.email }}{% endif %}
            {% else %}
                Vermieterdaten nicht hinterlegt
            {% endif %}
        </div>
    </div>

    <div class="section flex-row">
        <div class="flex-col summary-box">
            <strong>Mieter</strong><br>
            {% if tenant %}
                {{ tenant.first_name }} {{ tenant.last_name }}<br>
                {% if tenant.email %}{{ tenant.email }}<br>{% endif %}
                {% if tenant.phone %}Tel.: {{ tenant.phone }}<br>{% endif %}
            {% elif contract_data and contract_data.tenant_name %}
                {{ contract_data.tenant_name }}
            {% else %}
                (nicht hinterlegt)
            {% endif %}
        </div>
        <div class="flex-col summary-box">
            <strong>Objekt</strong><br>
            {% if building %}
                {{ building.name }}<br>
                {{ building.street }} {{ building.street_number }}<br>
                {{ building.zip_code }} {{ building.city }}<br>
            {% elif contract_data and contract_data.building_address %}
                {{ contract_data.building_address }}<br>
            {% endif %}
            Wohnung: {{ apartment.apartment_number if apartment else '' }}<br>
            Wohnfläche: {{ '%.2f'|format(settlement.apartment_area or 0) }} m²
        </div>
    </div>

    <div class="section summary-box">
        <h3>Vertragsdaten</h3>
        {% if contract_data %}
        {% set start_val = contract_data.start_date if contract else contract_data.get('start_date') %}
        {% set end_val = contract_data.end_date if contract else contract_data.get('end_date') %}
        {% set start_text = start_val.strftime('%d.%m.%Y') if start_val and start_val.__class__.__name__ == 'date' else start_val %}
        {% set end_text = end_val.strftime('%d.%m.%Y') if end_val and end_val.__class__.__name__ == 'date' else end_val %}
        {% set cold_rent_val = (contract_data.cold_rent if contract else contract_data.get('cold_rent')) or (contract_data.rent_net if contract else contract_data.get('rent_net')) %}
        {% set op_advance_val = (contract_data.operating_cost_advance if contract else contract_data.get('operating_cost_advance')) or 0 %}
        {% set heat_advance_val = (contract_data.heating_advance if contract else contract_data.get('heating_advance')) or 0 %}
        <p>
            Vertrag Nr. {{ contract_data.contract_number if contract else contract_data.get('contract_number') }}<br>
            Laufzeit:
            {% if start_text %}
                {{ start_text }}
            {% endif %}
            – {{ end_text if end_text else 'n/a' }}<br>
            Kaltmiete: {{ '%.2f'|format(cold_rent_val or 0) }} € / Monat<br>
            Vorauszahlung Betriebskosten/Heizung: {{ '%.2f'|format(op_advance_val + heat_advance_val) }} € / Monat
        </p>
        {% else %}
        <p>Keine Vertragsdaten gefunden.</p>
        {% endif %}
    </div>

    {% if settlement.tenant_notes %}
    <div class="section summary-box">
        <h3>Hinweise</h3>
        <p>{{ settlement.tenant_notes }}</p>
    </div>
    {% endif %}

    <div class="section summary-box">
        <h3>Zusammenfassung</h3>
        <table class="table">
            <tr>
                <th>Gesamtkostenanteil Mieter</th>
                <td style="text-align:right">{{ '%.2f'|format(settlement.total_costs or 0) }} €</td>
            </tr>
            <tr>
                <th>Geleistete Vorauszahlungen</th>
                <td style="text-align:right">- {{ '%.2f'|format(settlement.advance_payments or 0) }} €</td>
            </tr>
            <tr class="totals">
                <th>Saldo (Nachzahlung + / Guthaben -)</th>
                <td style="text-align:right">{{ '%.2f'|format(settlement.balance or 0) }} €</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <h3>Kostenaufstellung</h3>
        <table class="table cost-table">
            <thead>
                <tr>
                    <th>Beleg</th>
                    <th>Kostenart</th>
                    <th>Umlageschlüssel</th>
                    <th>Gesamtkosten</th>
                    <th>Anteil Mieter</th>
                    <th>Bemerkung</th>
                </tr>
            </thead>
            <tbody>
                {% for item in settlement.cost_breakdown or [] %}
                <tr>
                    <td>
                        {% if item.invoice_number %}<div>Rechnung: {{ item.invoice_number }}</div>{% endif %}
                        {% if item.billing_period %}<div>Zeitraum: {{ item.billing_period }}</div>{% endif %}
                        {% if item.apartment_specific %}<div class="badge">Wohnung</div>{% else %}<div class="badge">Gebäude</div>{% endif %}
                    </td>
                    <td>{{ item.category }}</td>
                    <td>{{ item.basis or item.method }}</td>
                    <td style="text-align:right">{{ '%.2f'|format(item.amount_total or 0) }} €</td>
                    <td style="text-align:right">{{ '%.2f'|format(item.share or 0) }} €</td>
                    <td>{{ item.note }}</td>
                </tr>
                {% else %}
                <tr><td colspan="6">Keine umlagefähigen Kosten erfasst.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>Verbrauchsnachweise</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Zähler</th>
                    <th>Einheit</th>
                    <th>Preis/x</th>
                    <th>Stand Start</th>
                    <th>Stand Ende</th>
                    <th>Verbrauch</th>
                    <th>Anteil Mieter</th>
                </tr>
            </thead>
            <tbody>
                {% for meter in settlement.consumption_details or [] %}
                <tr>
                    <td>{{ meter.meter_number }} ({{ meter.meter_type }})</td>
                    <td>{{ meter.unit }}</td>
                    <td>
                        {% if meter.price_per_unit is not none %}
                            {{ meter.price_per_unit }} €/{{ meter.unit or 'Einheit' }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ meter.start_value if meter.start_value is not none else '-' }} {% if meter.start_date %}({{ meter.start_date }}){% endif %}</td>
                    <td>{{ meter.end_value if meter.end_value is not none else '-' }} {% if meter.end_date %}({{ meter.end_date }}){% endif %}</td>
                    <td>{{ meter.consumption if meter.consumption is not none else '-' }}</td>
                    <td>
                        {% if meter.tenant_share is not none %}
                            {{ '%.2f'|format(meter.tenant_share) }} €
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="7">Keine Zählerstände verfügbar.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section notice">
        Gemäß § 556 Abs. 3 BGB kann der Mieter innerhalb von 12 Monaten nach Zugang der Abrechnung Einwendungen erheben.
        {% if balance_val > 0.01 %}
            Bitte überweisen Sie den Nachzahlungsbetrag innerhalb von 14 Tagen auf das unten stehende Konto.
        {% elif balance_val < -0.01 %}
            Wir zahlen ein Guthaben innerhalb von 14 Tagen auf die uns bekannte Bankverbindung aus. Bitte teilen Sie uns andernfalls ein Konto mit.
        {% else %}
            Es ist keine Zahlung erforderlich; die Abrechnung ist ausgeglichen.
        {% endif %}
    </div>

    <div class="section summary-box">
        <strong>Bankverbindung des Vermieters</strong><br>
        {% if landlord_data %}
            {% set iban_val = landlord_data.iban %}
            {% if iban_val %}
                {% set holder_val = landlord_data.account_holder %}
                {% set bic_val = landlord_data.bic %}
                {% set bank_val = landlord_data.bank_name %}
                {% set name_val = holder_val or landlord_data.company_name or landlord_data.company or landlord_data.name or (landlord_data.first_name ~ ' ' ~ landlord_data.last_name) %}
                Kontoinhaber: {{ name_val or '(nicht hinterlegt)' }}<br>
                IBAN: {{ iban_val }}<br>
                {% if bic_val %}BIC: {{ bic_val }}<br>{% endif %}
                {% if bank_val %}Bank: {{ bank_val }}{% endif %}
            {% else %}
                Keine Bankdaten hinterlegt.
            {% endif %}
        {% else %}
            Keine Bankdaten hinterlegt.
        {% endif %}
    </div>

    <div class="signature">
        <div class="line">Ort, Datum</div>
        <div class="line">Unterschrift Vermieter</div>
    </div>
</body>
</html>
