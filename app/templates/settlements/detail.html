{% extends "base.html" %}

{% block extra_css %}
<style>
    .btn-back-light {
        color: #fff;
        border-color: rgba(255, 255, 255, 0.65);
    }
    .btn-back-light:hover, .btn-back-light:focus {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.85);
        box-shadow: none;
    }
    .cost-table-wrapper {
        overflow-x: auto;
    }
    @media (min-width: 992px) {
        .cost-table-wrapper {
            overflow-x: visible;
        }
    }
    .cost-table-wrapper .table td,
    .cost-table-wrapper .table th {
        white-space: normal;
    }
    .cost-action-col {
        width: 52px;
    }
</style>
{% endblock %}

{% block title %}Abrechnung {{ settlement.id }} - Rental Management{% endblock %}

{% block content %}
{% set snapshot = contract_info.snapshot if contract_info is defined else settlement.contract_snapshot or {} %}
{% set cold_rent_val = (contract_info.cold_rent if contract_info is defined else None) or ((settlement.contract.cold_rent or settlement.contract.rent_net) if settlement.contract else (snapshot.get('cold_rent') or snapshot.get('rent_net'))) or 0 %}
<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator me-2"></i>Abrechnung {{ settlement.id }}
                </h5>
                <a href="/settlements" class="btn btn-outline-light btn-sm btn-back-light">
                    <i class="bi bi-arrow-left"></i> Zurück
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Allgemeine Informationen</h6>
                        <p><strong>Zeitraum:</strong> {{ settlement.period_start.strftime('%d.%m.%Y') }} - {{ settlement.period_end.strftime('%d.%m.%Y') }}</p>
                        <p><strong>Wohnung:</strong>
                            {% if settlement.apartment %}
                                {{ settlement.apartment.get_full_identifier() }}
                            {% endif %}
                        </p>
                        <p><strong>Mieter:</strong>
                            {% if settlement.tenant %}
                                {{ settlement.tenant.first_name }} {{ settlement.tenant.last_name }}
                            {% endif %}
                        </p>
                        <p><strong>Vertrag:</strong>
                            {% set snapshot = settlement.contract_snapshot or {} %}
                            {% if settlement.contract %}
                                Nr. {{ settlement.contract.contract_number }} ({{ settlement.contract.start_date.strftime('%d.%m.%Y') }}{% if settlement.contract.end_date %} - {{ settlement.contract.end_date.strftime('%d.%m.%Y') }}{% endif %})
                            {% elif snapshot %}
                                Nr. {{ snapshot.contract_number }}{% if snapshot.start_date %} (ab {{ snapshot.start_date }}){% endif %}
                            {% else %}
                                –
                            {% endif %}
                        </p>
                        <p><strong>Wohnfläche:</strong> {{ "%.2f"|format(settlement.apartment_area or 0) }} m²</p>
                        {% if settlement.apartment and settlement.apartment.building %}
                        <p class="mb-0"><strong>Gebäude:</strong> {{ settlement.apartment.building.name }}</p>
                        <small class="text-muted">{{ settlement.apartment.building.street }} {{ settlement.apartment.building.street_number }}, {{ settlement.apartment.building.zip_code }} {{ settlement.apartment.building.city }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Kostenübersicht</h6>
                        <p><strong>Gesamtkostenanteil:</strong> {{ "%.2f"|format(settlement.total_costs or 0) }} €</p>
                        <p><strong>Vorauszahlungen:</strong> {{ "%.2f"|format(settlement.advance_payments or 0) }} €</p>
                        {% if settlement.contract or snapshot %}
                        {% set monthly_adv = (contract_info.monthly_contract_advance if contract_info is defined else 0) or (contract_info.monthly_effective_advance if contract_info is defined else 0) %}
                        <p class="mb-1"><small class="text-muted">monatliche Vorauszahlung lt. Vertrag: {{ "%.2f"|format(monthly_adv or 0) }} €</small></p>
                        <p class="mb-1"><small class="text-muted">Kaltmiete: {{ "%.2f"|format(cold_rent_val) }} € / Monat</small></p>
                        {% endif %}
                        <p class="fw-bold"><strong>Saldo:</strong> {{ "%.2f"|format(settlement.balance or 0) }} €</p>
                    </div>
                </div>
                {% if settlement.contract or snapshot %}
                <div class="row">
                    <div class="col-md-12">
                        <h6>Vertragsdetails</h6>
                        {% set op_adv = (settlement.contract.operating_cost_advance if settlement.contract else snapshot.get('operating_cost_advance') or 0) %}
                        {% set heat_adv = (settlement.contract.heating_advance if settlement.contract else snapshot.get('heating_advance') or 0) %}
                        {% set monthly_adv = (contract_info.monthly_contract_advance if contract_info is defined else None) or (contract_info.monthly_effective_advance if contract_info is defined else None) or (snapshot.get('monthly_advance') if not settlement.contract else None) %}
                        <p class="text-muted mb-1">
                            Kaltmiete: {{ "%.2f"|format(cold_rent_val) }} € / Monat ·
                            Vorauszahlung BK/HZ: {{ "%.2f"|format((monthly_adv if monthly_adv is not none else (op_adv + heat_adv)) or 0) }} € / Monat ·
                            Wohnfläche Abrechnung: {{ "%.2f"|format(settlement.apartment_area or 0) }} m²
                        </p>
                        {% if snapshot.landlord %}
                        <small class="text-muted">Vermieter: {{ snapshot.landlord.company or snapshot.landlord.name }} · {{ snapshot.landlord.street }} {{ snapshot.landlord.street_number }}, {{ snapshot.landlord.zip_code }} {{ snapshot.landlord.city }}</small>
                        {% elif settlement.contract and settlement.contract.landlord %}
                        <small class="text-muted">Vermieter: {{ settlement.contract.landlord.company_name or settlement.contract.landlord.first_name ~ ' ' ~ settlement.contract.landlord.last_name }}</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% if settlement.tenant_notes %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Hinweise für den Mieter</h6>
                        <p class="mb-0">{{ settlement.tenant_notes }}</p>
                    </div>
                </div>
                {% endif %}
                <hr>
                <h6>Kostenarten</h6>
                <div class="table-responsive cost-table-wrapper">
                    <table class="table table-sm">
                        <thead>
                            <tr class="small">
                                <th>Beleg</th>
                                <th>Art</th>
                                <th>Schl.</th>
                                <th>Verbrauch</th>
                                <th>Summe</th>
                                <th>Anteil</th>
                                <th>Hinweis</th>
                                <th class="text-end cost-action-col" title="Bearbeiten"><i class="bi bi-pencil"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in settlement.cost_breakdown or [] %}
                            <tr>
                                <td>
                                    {% if item.invoice_number %}<div class="small text-muted">Rechnung: {{ item.invoice_number }}</div>{% endif %}
                                    {% if item.billing_period %}<div class="small text-muted">Zeitraum: {{ item.billing_period }}</div>{% endif %}
                                    {% if item.apartment_specific %}<span class="badge bg-secondary">Wohnung</span>{% else %}<span class="badge bg-info text-dark">Gebäude</span>{% endif %}
                                </td>
                                <td>{{ item.category }}</td>
                                <td>{{ item.basis or item.method }}</td>
                                <td>
                                    {% if item.tenant_consumption is not none and item.total_consumption is not none %}
                                        {{ "%.2f"|format(item.tenant_consumption or 0) }} / {{ "%.2f"|format(item.total_consumption or 0) }} {{ item.unit or '' }}
                                    {% else %}
                                        –
                                    {% endif %}
                                </td>
                                <td>{{ "%.2f"|format(item.amount_total or 0) }} €</td>
                                <td>{{ "%.2f"|format(item.share or 0) }} €</td>
                                <td>{{ item.note }}</td>
                                <td class="text-end">
                                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('costs.costs_home') }}?edit_cost={{ item.cost_id }}&next=/settlements#costModal" title="Kostenposition bearbeiten">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="text-muted">Keine Kosten erfasst.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <hr>
                <h6>Verbrauchszähler</h6>
                {% set consumption_meters = (settlement.consumption_details or []) | selectattr('apartment_id', 'equalto', settlement.apartment_id) | list %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Zähler</th>
                                <th>Einheit</th>
                                <th>Preis/x</th>
                                <th>Stand Anfang</th>
                                <th>Stand Ende</th>
                                <th>Verbrauch</th>
                                <th>Anteil Mieter</th>
                                <th class="text-end" title="Bearbeiten"><i class="bi bi-pencil"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meter in consumption_meters %}
                            <tr>
                                <td>{{ meter.meter_number }} {% if meter.meter_type %}({{ meter.meter_type }}){% endif %}</td>
                                <td>{{ meter.get('unit') or '' }}</td>
                                <td>
                                    {% if meter.get('price_per_unit') is not none %}
                                        {{ meter.get('price_per_unit') }} €/{{ meter.get('unit') or 'Einheit' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ meter.get('start_value') if meter.get('start_value') is not none else '-' }} {% if meter.get('start_date') %}<small class="text-muted">({{ meter.get('start_date') }})</small>{% endif %}</td>
                                <td>{{ meter.get('end_value') if meter.get('end_value') is not none else '-' }} {% if meter.get('end_date') %}<small class="text-muted">({{ meter.get('end_date') }})</small>{% endif %}</td>
                                <td>{{ meter.get('consumption') if meter.get('consumption') is not none else '-' }}</td>
                                <td>
                                    {% if meter.get('tenant_share') is not none %}
                                        {{ '%.2f'|format(meter.get('tenant_share')) }} €
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if meter.get('meter_id') %}
                                    <a class="btn btn-outline-secondary btn-sm" href="/meters/{{ meter.get('meter_id') }}/edit?next=/settlements" title="Zähler bearbeiten">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% else %}
                                    <span class="text-muted">–</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="text-muted">Keine Zählerstände im Zeitraum gefunden.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">Aktionen</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#settlementEditModal"
                        data-id="{{ settlement.id }}"
                        data-apartment="{{ settlement.apartment_id }}"
                        data-start="{{ settlement.period_start.strftime('%Y-%m-%d') }}"
                        data-end="{{ settlement.period_end.strftime('%Y-%m-%d') }}"
                        data-status="{{ settlement.status }}"
                        data-notes="{{ settlement.notes or '' }}"
                        data-tenant-notes="{{ settlement.tenant_notes or '' }}">
                        <i class="bi bi-pencil-square me-1"></i> Abrechnung bearbeiten
                    </button>
                    <a href="/settlements/{{ settlement.id }}/pdf" class="btn btn-outline-primary">
                        <i class="bi bi-file-pdf me-1"></i> PDF herunterladen
                    </a>
                    <form method="POST" action="/settlements/{{ settlement.id }}/archive">
                        {% if settlement.is_archived %}
                        <input type="hidden" name="action" value="restore">
                        <button type="submit" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> Archivierung aufheben
                        </button>
                        {% else %}
                        <input type="hidden" name="action" value="archive">
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-archive me-1"></i> Archivieren
                        </button>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% include 'settlements/edit_modal.html' %}
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('settlementEditModal');
        const form = document.getElementById('settlementEditForm');
        const apartmentField = document.getElementById('settlementApartment');
        const startField = document.getElementById('settlementPeriodStart');
        const endField = document.getElementById('settlementPeriodEnd');
        const statusField = document.getElementById('settlementStatus');
        const notesField = document.getElementById('settlementNotes');
        const tenantNotesField = document.getElementById('settlementTenantNotes');

        const fillFromTrigger = (trigger) => {
            if (!trigger) return;
            const id = trigger.getAttribute('data-id');
            form.action = `/settlements/${id}/edit?force_page=1`;
            apartmentField.value = trigger.getAttribute('data-apartment') || '';
            startField.value = trigger.getAttribute('data-start') || '';
            endField.value = trigger.getAttribute('data-end') || '';
            statusField.value = trigger.getAttribute('data-status') || 'draft';
            notesField.value = trigger.getAttribute('data-notes') || '';
            tenantNotesField.value = trigger.getAttribute('data-tenant-notes') || '';
        };

        modal?.addEventListener('show.bs.modal', (event) => {
            fillFromTrigger(event.relatedTarget);
        });

        const params = new URLSearchParams(window.location.search);
        if (params.get('edit') === '1' && modal) {
            const triggerBtn = document.querySelector('[data-bs-target="#settlementEditModal"]');
            if (triggerBtn) {
                fillFromTrigger(triggerBtn);
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();
            }
        }
    });
</script>
{% endblock %}