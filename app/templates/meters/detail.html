{% extends "base.html" %}

{% block title %}Zähler {{ meter.meter_number }} - MietAssistent{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">
        <i class="bi bi-speedometer2 text-primary me-2"></i>Zähler: {{ meter.meter_number }}
    </h1>
    <div class="btn-group">
        <a href="{{ url_for('meters.edit_meter', meter_id=meter.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil me-1"></i>Bearbeiten
        </a>
        <a href="{{ url_for('meters.meters_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Zurück
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Zählerinformationen</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th class="text-muted">Zählernummer:</th>
                                <td><strong>{{ meter.meter_number }}</strong></td>
                            </tr>
                            <tr>
                                <th class="text-muted">Beschreibung:</th>
                                <td>{{ meter.description or '-' }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Zählertyp:</th>
                                <td>
                                    <span class="badge bg-info">{{ meter.meter_type.name }}</span>
                                    ({{ meter.meter_type.unit }})
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Kategorie:</th>
                                <td>{{ meter.meter_type.category }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th class="text-muted">Gebäude:</th>
                                <td>{{ meter.building.name }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Wohnung:</th>
                                <td>
                                    {% if meter.apartment %}
                                        {{ meter.apartment.apartment_number }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Hauptzähler:</th>
                                <td>
                                    {% if meter.is_main_meter %}
                                        <span class="badge bg-success">Ja</span> 
                                    {% else %}
                                        <span class="badge bg-secondary">Nein</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th class="text-muted">Virtueller Zähler:</th>
                                <td>
                                    {% if meter.is_virtual_meter %}
                                        <span class="badge bg-warning">Ja</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Nein</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                {% if meter.parent_meter %}
                <div class="row mt-3">
                    <div class="col-12">
                        <strong>Übergeordneter Zähler:</strong>
                        <a href="{{ url_for('meters.meter_detail', meter_id=meter.parent_meter.id) }}">
                            {{ meter.parent_meter.meter_number }} - {{ meter.parent_meter.description or '' }}
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if meter.sub_meters %}
                <div class="row mt-3">
                    <div class="col-12">
                        <strong>Unterzähler:</strong>
                        <ul class="list-group mt-2">
                            {% for submeter in meter.sub_meters %}
                            <li class="list-group-item">
                                <a href="{{ url_for('meters.meter_detail', meter_id=submeter.id) }}">
                                    {{ submeter.meter_number }} - {{ submeter.description or '' }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Technische Daten</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tr>
                        <th class="text-muted">Hersteller:</th>
                        <td>{{ meter.manufacturer or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Modell:</th>
                        <td>{{ meter.model or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Installationsdatum:</th>
                        <td>{{ meter.installation_date or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Multiplikator:</th>
                        <td>{{ meter.multiplier }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">Standort:</th>
                        <td>{{ meter.location_description or '-' }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">Notizen</h5>
            </div>
            <div class="card-body">
                <p class="card-text">{{ meter.notes or 'Keine Notizen vorhanden.' }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Letzte Zählerstände -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Letzte Zählerstände</h5>
        <a href="{{ url_for('meter_readings.create_meter_reading') }}?meter_id={{ meter.id }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Neuer Zählerstand
        </a>
    </div>
    <div class="card-body">
        {% if readings %}
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Wert</th>
                        <th>Typ</th>
                        <th>Erfasst von</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reading in readings %}
                    <tr>
                        <td>{{ reading.reading_date.strftime('%d.%m.%Y') }}</td>
                        <td><strong>{{ reading.reading_value }} {{ meter.meter_type.unit }}</strong></td>
                        <td>
                            <span class="badge {% if reading.reading_type == 'actual' %}bg-success{% else %}bg-warning{% endif %}">
                                {{ reading.reading_type }}
                            </span>
                        </td>
                        <td>{{ reading.user.username if reading.user else 'System' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center py-3">Noch keine Zählerstände erfasst.</p>
        {% endif %}
    </div>
</div>
{% endblock %}